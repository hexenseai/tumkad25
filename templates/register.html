{% extends "base.html" %}

{% block title %}TUMKAD AI Projesi - Gelecek Vizyonu Katılımcı Bilgileri{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card border-0 shadow">
            <div class="card-header bg-primary text-white text-center">
                <img src="{{ url_for('static', filename='images/form-header.png') }}" alt="TUMKAD" class="mb-3" style="display: block; margin-left: auto; margin-right: auto; max-width: 100%; height: auto; object-fit: contain;">
                <h2 class="mb-0">
                    <i class="fas fa-robot"></i> TUMKAD AI Gelecek Vizyonu Katılımcı Bilgileri
                </h2>
                <p class="mb-0 mt-2">TUMKAD Yapay Zeka Destekli Gelecek Vizyonu Projesi</p>
            </div>
            <div class="card-body p-4">
                <div class="alert alert-info" role="alert">
                    <h6><i class="fas fa-info-circle"></i> Proje Hakkında:</h6>
                    <p class="mb-0">Değerli TUMKAD Sempozyumu katılımcısı, bu form, geleceğe dair vizyonunuzu ve mesleki bilgilerinizi AI destekli bir görsel ve video deneyimine dönüştürmek için kullanılacaktır. Sağladığınız bilgiler, 2035 yılında gerçekleştireceğiniz yüksek etkili bir proje hikayesi ve bu hikayenin görsel canlandırması için kullanılacaktır. Bilgileriniz gizlilik politikamız doğrultusunda korunacaktır.</p>
                </div>

                <form method="POST" enctype="multipart/form-data" id="registerForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="phone" class="form-label">
                                    <i class="fab fa-whatsapp"></i> WhatsApp Telefon Numarası *
                                </label>
                                <input type="tel" class="form-control" id="phone" name="phone" required placeholder="+90 5XX XXX XX XX">
                                <div class="form-text">Numaranızı başında +90, 0, 90 veya doğrudan 5 ile başlayarak girebilirsiniz. Otomatik olarak formatlanacaktır.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    <i class="fas fa-user"></i> Adınız Soyadınız *
                                </label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope"></i> E-posta Adresiniz *
                                </label>
                                <input type="email" class="form-control" id="email" name="email" required placeholder="ornek@email.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="profession" class="form-label">
                                    <i class="fas fa-briefcase"></i> Mesleğiniz / Temel Uzmanlık Alanı *
                                </label>
                                <input type="text" class="form-control" id="profession" name="profession" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="photo" class="form-label">
                            <i class="fas fa-camera"></i> Gelecek Vizyonunuzu oluşturmak için portre fotoğrafınızı yükleyiniz. *
                        </label>
                        <div class="input-group">
                            <input type="file" class="form-control" id="photo" name="photo" accept="image/*" required>
                            <button class="btn btn-outline-secondary" type="button" id="captureBtn">
                                <i class="fas fa-camera"></i> Fotoğraf Çek
                            </button>
                        </div>
                        <div class="form-text" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
                            <strong>Lütfen Net Bir Fotoğrafınızı Yükleyiniz:</strong><br>
                            Yüksek Kaliteli Bir Görsel Oluşturabilmemiz İçin Fotoğrafınızın Aşağıdaki Özelliklere Sahip Olmasına Lütfen Dikkat Ediniz:
                        </div>
                        <div class="alert alert-warning mt-2">
                            <ul class="mb-0 small">
                                <li><strong>Aydınlatma:</strong> Yüzünüzün tamamen aydınlık olduğundan emin olun. Doğal ışık idealdir.</li>
                                <li><strong>Netlik ve Odak:</strong> Fotoğrafınızın bulanık olmadığından, yüzünüzün net bir şekilde odakta olduğundan emin olun.</li>
                                <li><strong>Yüz Konumu:</strong> Kameraya direkt olarak bakın. Yüzünüzün tamamı net bir şekilde görünmelidir.</li>
                                <li><strong>Kompozisyon:</strong> Yüzünüz görselin yaklaşık %15-20'sini kaplamalıdır.</li>
                                <li><strong>Arka Plan:</strong> Sade ve düzenli bir arka plan tercih edin.</li>
                                <li><strong>Filtre ve Efekt Yok:</strong> Doğal halinizle yükleyin.</li>
                                <li><strong>Dosya Türü:</strong> JPEG veya PNG formatında olmalıdır.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Photo Preview -->
                    <div class="mb-4" id="photoPreview" style="display: none;">
                        <div class="text-center">
                            <img id="previewImg" src="" alt="Fotoğraf Önizleme" class="img-fluid rounded" style="max-height: 300px;">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sector" class="form-label">
                                    <i class="fas fa-industry"></i> Çalıştığınız Sektör *
                                </label>
                                <select class="form-select" id="sector" name="sector" required>
                                    <option value="">Sektör seçiniz...</option>
                                    <option value="Otomotiv">Otomotiv</option>
                                    <option value="Eğitim, Danışmanlık ve İnsan Kaynakları">Eğitim, Danışmanlık ve İnsan Kaynakları</option>
                                    <option value="Bilişim ve Teknoloji">Bilişim ve Teknoloji</option>
                                    <option value="Kimya">Kimya</option>
                                    <option value="Tekstil">Tekstil</option>
                                    <option value="Perakende">Perakende</option>
                                    <option value="İmalat / Üretim (Diğer Sanayiler)">İmalat / Üretim (Diğer Sanayiler)</option>
                                    <option value="İnşaat, Gayrimenkul ve İç Mimarlık">İnşaat, Gayrimenkul ve İç Mimarlık</option>
                                    <option value="Gıda ve Tarım">Gıda ve Tarım</option>
                                    <option value="Enerji, Elektrik ve Çevre">Enerji, Elektrik ve Çevre</option>
                                    <option value="Kamu Kurumları / Devlet">Kamu Kurumları / Devlet</option>
                                    <option value="Genel Hizmetler">Genel Hizmetler (Ör.: Turizm, Organizasyon, Medya, İletişim, Pazarlama, Sigorta, Ulaştırma, Denizcilik, Hukuk, Fikri ve Sınai Haklar vb.)</option>
                                    <option value="Sağlık">Sağlık</option>
                                    <option value="Sivil Toplum Kuruluşları (STK)">Sivil Toplum Kuruluşları (STK)</option>
                                    <option value="Öğrenci">Öğrenci</option>
                                    <option value="Çalışmıyor / İş Arıyorum">Çalışmıyor / İş Arıyorum</option>
                                    <option value="Emekli">Emekli</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="technical_interest" class="form-label">
                            <i class="fas fa-lightbulb"></i> Sizi En Çok Heyecanlandıran Teknik Alan veya Özel İlgi Alanınız Nedir? *
                        </label>
                        <div class="form-text mb-2" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
                            <strong>Örnekler:</strong> "Yenilenebilir enerji kaynaklarını herkes için erişilebilir kılmak", "AI destekli kişiselleştirilmiş tedavilerle hastalıkları önlemek", "Uzayda kendi kendine yeten yaşam alanları tasarlamak" gibi büyük ve cesur bir hayal kurun.
                        </div>
                        <textarea class="form-control" id="technical_interest" name="technical_interest" rows="3" required 
                                placeholder="Lütfen 1-2 cümle ile özetleyin. Bu, projenin ana fikrini oluşturacak."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="future_impact" class="form-label">
                            <i class="fas fa-rocket"></i> 2035 Yılında, Uzmanlık Alanınızla Dünyada Yaratmak İstediğiniz En Büyük Etki veya Çözmek İstediğiniz En Büyük Sorun Ne Olurdu? *
                        </label>
                        <div class="form-text mb-2" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
                            <strong>Örnekler:</strong> "Küresel iklim değişikliğini tersine çevirmek", "Dünya genelinde temiz su erişimini sağlamak", "Yapay zeka ile eğitimde fırsat eşitliği yaratmak" gibi dönüştürücü bir vizyon belirtin.
                        </div>
                        <textarea class="form-control" id="future_impact" name="future_impact" rows="3" required
                                placeholder="Lütfen uzmanlık alanınızla ilgili 2035 yılında gerçekleştirmek istediğiniz en büyük etkiyi açıklayın."></textarea>
                    </div>

                    <!-- Camera Capture Modal -->
                    <div class="modal fade" id="cameraModal" tabindex="-1">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-camera"></i> Fotoğraf Çek (Kare Format)
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center p-0">
                                    <div class="camera-container" style="position: relative; background: #000; border-radius: 8px; overflow: hidden; height: 400px; width: 100%;">
                                        <video id="camera" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none;" autoplay muted playsinline></video>
                                        <div id="cameraLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center; z-index: 10;">
                                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                            <br>
                                            <small>Kamera yükleniyor...</small>
                                        </div>
                                        <!-- Kare format kılavuzu -->
                                        <div id="squareGuide" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 300px; border: 2px solid rgba(255,255,255,0.7); border-radius: 8px; display: none; pointer-events: none; z-index: 5;"></div>
                                    </div>
                                    <canvas id="canvas" style="display: none;"></canvas>
                                </div>
                                <div class="modal-footer justify-content-center">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times"></i> İptal
                                    </button>
                                    <button type="button" class="btn btn-primary btn-lg" id="capturePhotoBtn" disabled>
                                        <i class="fas fa-camera"></i> Fotoğraf Çek
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-success" role="alert">
                        <h6><i class="fas fa-check-circle"></i> KVKK Aydınlatma Metni:</h6>
                        <p class="mb-2">Bu formu doldurarak ve fotoğrafınızı yükleyerek, yukarıda belirtilen şartlar ve KVKK Aydınlatma Metni doğrultusunda kişisel verilerinizin işlenmesini ve kullanılmasını kabul etmiş olursunuz.</p>
                        <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#kvkkModal">
                            <i class="fas fa-file-text"></i> Detaylı KVKK Aydınlatma Metni
                        </button>
                    </div>

                    <!-- KVKK Consent Checkbox -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="kvkkConsent" name="kvkk_consent" required>
                            <label class="form-check-label" for="kvkkConsent">
                                <strong>KVKK Onayı *</strong><br>
                                <small class="text-muted">
                                    Kişisel Verilerin Korunması Kanunu (KVKK) kapsamında, yukarıda belirtilen amaçlarla kişisel verilerimin işlenmesini ve kullanılmasını kabul ediyorum. 
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#kvkkModal" class="text-decoration-none">Detaylı aydınlatma metnini</a> okudum ve anladım.
                                </small>
                            </label>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                            <i class="fas fa-paper-plane"></i> Kayıt Ol
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- KVKK Modal -->
<div class="modal fade" id="kvkkModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">KVKK Aydınlatma Metni</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Değerli TUMKAD Sempozyumu katılımcısı,</h6>
                <p>Bu form, "TUMKAD Yapay Zeka Destekli Gelecek Vizyonu Projesi" kapsamında, sizin ve bir diğer mühendis meslektaşınızın 2035 yılına dair yenilikçi vizyonlarını yapay zeka aracılığıyla kişiselleştirilmiş bir görsel ve video deneyimine dönüştürmek amacıyla hazırlanmıştır.</p>
                
                <h6>Hangi Verileriniz Toplanacaktır?</h6>
                <ul>
                    <li><strong>Kimlik ve İletişim Bilgileri:</strong> Adınız Soyadınız, WhatsApp Telefon Numaranız.</li>
                    <li><strong>Profesyonel Bilgiler:</strong> Mesleğiniz / Temel Uzmanlık Alanınız, Çalıştığınız Sektör, Özel İlgi Alanlarınız.</li>
                    <li><strong>Vizyon Bilgileri:</strong> 2035 yılına dair gelecek vizyonunuzu ve bu vizyonu hayata geçirirken kendinizi hayal ettiğiniz ortamı içeren metinsel bilgiler.</li>
                    <li><strong>Fotoğraf:</strong> Form üzerinden yükleyeceğiniz bireysel fotoğrafınız.</li>
                </ul>

                <h6>Verileriniz Nasıl İşlenecek ve Kullanılacaktır?</h6>
                <p>Toplanan verileriniz, tamamen bu projenin amacına hizmet etmek üzere aşağıdaki şekillerde yapay zeka modelleriyle işlenecektir:</p>
                <ul>
                    <li><strong>Hikaye Oluşturma:</strong> Mesleki bilgileriniz ve vizyonlarınız, Google'ın gelişmiş dil modelleri (Vertex AI Gemini API) aracılığıyla analiz edilerek, sizin ve bir diğer katılımcının 2035 yılında birlikte gerçekleştireceği yüksek etkili bir proje hikayesine dönüştürülecektir.</li>
                    <li><strong>Görsel ve Video Üretimi:</strong> Oluşturulan hikaye ve sizin fotoğrafınız, Google'ın görüntü ve video üretim modelleri (Vertex AI Imagen 3 ve Veo 3) kullanılarak, 9:16 dikey formatında, iki mühendisin de yer aldığı gerçekçi bir illüstrasyon görseline ve bu görselin 8 saniyelik dinamik bir video canlandırmasına dönüştürülecektir.</li>
                    <li><strong>İletişim:</strong> Oluşturulan görsel ve video çıktısının bağlantı linki, belirttiğiniz WhatsApp telefon numaranıza gönderilecektir.</li>
                </ul>

                <h6>Veri Gizliliği ve Güvenliği:</h6>
                <ul>
                    <li>Toplanan tüm verileriniz, Google Cloud Platform'un güvenli altyapısında (Google Cloud Storage, Google Sheets) saklanacaktır.</li>
                    <li>Verileriniz, yalnızca bu projede belirtilen amaçlar doğrultusunda kullanılacak ve üçüncü taraflarla paylaşılmayacaktır.</li>
                    <li>Etkinliğin tamamlanmasının ardından, kişisel verileriniz (iletişim bilgileri ve yüklenen fotoğraflar) belirlenen süre sonunda güvenli bir şekilde silinecektir.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* Disable all hover effects to prevent interference with video */
* {
    transition: none !important;
    animation: none !important;
}

*:hover {
    transform: none !important;
    transition: none !important;
}

/* Ensure video element is completely stable */
#camera {
    transition: none !important;
    animation: none !important;
    transform: none !important;
}

#camera:hover {
    transform: none !important;
    transition: none !important;
}

/* Disable any Bootstrap hover effects */
.btn:hover {
    transform: none !important;
    transition: none !important;
}

.modal:hover {
    transform: none !important;
    transition: none !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const photoInput = document.getElementById('photo');
    const photoPreview = document.getElementById('photoPreview');
    const previewImg = document.getElementById('previewImg');
    const captureBtn = document.getElementById('captureBtn');
    const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
    const camera = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const capturePhotoBtn = document.getElementById('capturePhotoBtn');
    const kvkkConsent = document.getElementById('kvkkConsent');
    const submitBtn = document.getElementById('submitBtn');
    const registerForm = document.getElementById('registerForm');
    let stream = null;
    let isCameraActive = false;

    // Force visibility of all form-text elements
    function ensureFormTextVisibility() {
        const formTextElements = document.querySelectorAll('.form-text');
        formTextElements.forEach(element => {
            element.style.display = 'block';
            element.style.visibility = 'visible';
            element.style.opacity = '1';
        });
    }

    // Call on page load
    ensureFormTextVisibility();

    // Also call after a short delay to ensure it works
    setTimeout(ensureFormTextVisibility, 100);
    setTimeout(ensureFormTextVisibility, 500);
    setTimeout(ensureFormTextVisibility, 1000);

    // Start camera function
    async function startCamera() {
        if (isCameraActive) return;
        
        try {
            // Show loading state
            const cameraLoading = document.getElementById('cameraLoading');
            const capturePhotoBtn = document.getElementById('capturePhotoBtn');
            
            cameraLoading.style.display = 'block';
            capturePhotoBtn.disabled = true;
            
            // Stop any existing stream first
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Request camera access with mobile-friendly constraints
            stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'user', // Use front camera on mobile
                    width: { ideal: 1280, max: 1920 },
                    height: { ideal: 720, max: 1080 }
                },
                audio: false
            });
            
            camera.srcObject = stream;
            
            // Wait for video to be ready
            camera.onloadedmetadata = function() {
                // Video'nun tam olarak yüklenmesini bekle
                setTimeout(() => {
                    // Show video
                    camera.style.display = 'block';
                    
                    // Show square guide
                    const squareGuide = document.getElementById('squareGuide');
                    squareGuide.style.display = 'block';
                    
                    // Hide loading and enable button
                    cameraLoading.style.display = 'none';
                    capturePhotoBtn.disabled = false;
                    
                    isCameraActive = true;
                    camera.play();
                    
                    console.log('Camera ready - Video dimensions:', camera.videoWidth, 'x', camera.videoHeight);
                }, 1000); // 1 saniye bekle
            };
            
        } catch (error) {
            console.error('Camera access error:', error);
            alert('Kamera erişimi sağlanamadı. Lütfen kamera izinlerini kontrol edin ve tekrar deneyin.');
            cameraModal.hide();
        }
    }

    // Stop camera function
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        isCameraActive = false;
        
        // Reset UI state
        const cameraLoading = document.getElementById('cameraLoading');
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const squareGuide = document.getElementById('squareGuide');
        
        camera.style.display = 'none';
        cameraLoading.style.display = 'block';
        squareGuide.style.display = 'none';
        capturePhotoBtn.disabled = true;
    }

    // KVKK Consent validation
    function validateForm() {
        const isKvkkChecked = kvkkConsent.checked;
        const isPhotoSelected = photoInput.files.length > 0;
        const isPhoneFilled = document.getElementById('phone').value.trim() !== '';
        const isNameFilled = document.getElementById('name').value.trim() !== '';
        const isProfessionFilled = document.getElementById('profession').value.trim() !== '';
        const isSectorSelected = document.getElementById('sector').value !== '';
        const isTechnicalInterestFilled = document.getElementById('technical_interest').value.trim() !== '';
        const isFutureImpactFilled = document.getElementById('future_impact').value.trim() !== '';

        const allRequiredFieldsFilled = isPhoneFilled && isNameFilled && isProfessionFilled && 
                                       isSectorSelected && isTechnicalInterestFilled && 
                                       isFutureImpactFilled && isPhotoSelected && isKvkkChecked;

        submitBtn.disabled = !allRequiredFieldsFilled;
        
        if (allRequiredFieldsFilled) {
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-primary');
        } else {
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-secondary');
        }
    }

    // Add event listeners for form validation
    kvkkConsent.addEventListener('change', validateForm);
    photoInput.addEventListener('change', validateForm);
    document.getElementById('phone').addEventListener('input', validateForm);
    document.getElementById('name').addEventListener('input', validateForm);
    document.getElementById('profession').addEventListener('input', validateForm);
    document.getElementById('sector').addEventListener('change', validateForm);
    document.getElementById('technical_interest').addEventListener('input', validateForm);
    document.getElementById('future_impact').addEventListener('input', validateForm);

    // File input change handler
    photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Yüklenen görseli kare formata dönüştür
                const img = new Image();
                img.onload = function() {
                    // Canvas oluştur ve kare format için kırp
                    const ctx = canvas.getContext('2d');
                    
                    // 1024x1024 hedef boyut
                    const targetSize = 1024;
                    canvas.width = targetSize;
                    canvas.height = targetSize;
                    
                    // Görsel boyutlarını al
                    const imgWidth = img.width;
                    const imgHeight = img.height;
                    
                    // Kare kırpma hesaplaması
                    let sourceX, sourceY, sourceWidth, sourceHeight;
                    
                    if (imgWidth > imgHeight) {
                        // Görsel geniş, yüksekliğe göre kırp
                        sourceHeight = imgHeight;
                        sourceWidth = imgHeight;
                        sourceX = (imgWidth - imgHeight) / 2;
                        sourceY = 0;
                    } else {
                        // Görsel yüksek, genişliğe göre kırp
                        sourceWidth = imgWidth;
                        sourceHeight = imgWidth;
                        sourceX = 0;
                        sourceY = (imgHeight - imgWidth) / 2;
                    }
                    
                    // Kare kırpılmış görüntüyü canvas'a çiz
                    ctx.drawImage(
                        img,
                        sourceX, sourceY, sourceWidth, sourceHeight,  // Kaynak kırpma
                        0, 0, targetSize, targetSize                   // Hedef boyut
                    );
                    
                    // Canvas'tan blob oluştur
                    canvas.toBlob(function(blob) {
                        // Yeni dosyayı input'a ata
                        const newFile = new File([blob], 'square_photo.jpg', { type: 'image/jpeg' });
                        const dt = new DataTransfer();
                        dt.items.add(newFile);
                        photoInput.files = dt.files;
                        
                        // Preview göster
                        previewImg.src = URL.createObjectURL(blob);
                        photoPreview.style.display = 'block';
                        
                        // Form validasyonu
                        validateForm();
                        
                        console.log('Fotoğraf kare formata dönüştürüldü (1024x1024)');
                    }, 'image/jpeg', 0.9);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Camera capture button
    captureBtn.addEventListener('click', function(e) {
        e.preventDefault();
        cameraModal.show();
    });

    // Start camera when modal is fully shown
    document.getElementById('cameraModal').addEventListener('shown.bs.modal', function() {
        startCamera();
    });

    // Stop camera when modal is closed
    document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function() {
        stopCamera();
    });

    // Capture photo
    capturePhotoBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!isCameraActive || !stream) {
            alert('Kamera henüz hazır değil. Lütfen bekleyin ve tekrar deneyin.');
            return;
        }
        
        try {
            // Video'nun hazır olduğundan emin ol
            if (camera.readyState < 2) {
                alert('Video henüz hazır değil. Lütfen birkaç saniye bekleyin ve tekrar deneyin.');
                return;
            }
            
            // Ayrı bir canvas oluştur (gizli canvas ile karışmaması için)
            const captureCanvas = document.createElement('canvas');
            const context = captureCanvas.getContext('2d');
            
            // Video boyutlarını al
            const videoWidth = camera.videoWidth;
            const videoHeight = camera.videoHeight;
            
            console.log('Video dimensions:', videoWidth, 'x', videoHeight);
            
            // Video boyutları geçerli mi kontrol et
            if (videoWidth === 0 || videoHeight === 0) {
                alert('Video boyutları alınamadı. Lütfen tekrar deneyin.');
                return;
            }
            
            // Kare format için boyutları hesapla (1024x1024)
            const targetSize = 1024;
            captureCanvas.width = targetSize;
            captureCanvas.height = targetSize;
            
            // Video aspect ratio'suna göre kare kırpma yap
            let sourceX, sourceY, sourceWidth, sourceHeight;
            
            if (videoWidth > videoHeight) {
                // Video geniş, yüksekliğe göre kırp
                sourceHeight = videoHeight;
                sourceWidth = videoHeight;
                sourceX = (videoWidth - videoHeight) / 2;
                sourceY = 0;
            } else {
                // Video yüksek, genişliğe göre kırp
                sourceWidth = videoWidth;
                sourceHeight = videoWidth;
                sourceX = 0;
                sourceY = (videoHeight - videoWidth) / 2;
            }
            
            console.log('Crop dimensions:', sourceX, sourceY, sourceWidth, sourceHeight);
            
            // Kare kırpılmış görüntüyü canvas'a çiz
            context.drawImage(
                camera,
                sourceX, sourceY, sourceWidth, sourceHeight,  // Kaynak kırpma
                0, 0, targetSize, targetSize                   // Hedef boyut
            );
            
            captureCanvas.toBlob(function(blob) {
                if (!blob) {
                    alert('Fotoğraf oluşturulamadı. Lütfen tekrar deneyin.');
                    return;
                }
                
                const file = new File([blob], 'captured_photo.jpg', { type: 'image/jpeg' });
                const dt = new DataTransfer();
                dt.items.add(file);
                photoInput.files = dt.files;
                
                // Show preview
                previewImg.src = URL.createObjectURL(blob);
                photoPreview.style.display = 'block';
                
                // Validate form after photo capture
                validateForm();
                
                // Stop camera and close modal
                stopCamera();
                cameraModal.hide();
                
                // Show success message
                setTimeout(() => {
                    alert('Kare format fotoğraf başarıyla çekildi! (1024x1024)');
                }, 100);
                
            }, 'image/jpeg', 0.9); // 90% quality for better file size
            
        } catch (error) {
            console.error('Photo capture error:', error);
            alert('Fotoğraf çekilirken bir hata oluştu. Lütfen tekrar deneyin.');
        }
    });

    // Form submission validation
    registerForm.addEventListener('submit', function(e) {
        if (!kvkkConsent.checked) {
            e.preventDefault();
            alert('Lütfen KVKK onayını veriniz.');
            kvkkConsent.focus();
            return false;
        }
        
        if (!photoInput.files.length) {
            e.preventDefault();
            alert('Lütfen bir fotoğraf yükleyiniz.');
            photoInput.focus();
            return false;
        }
    });

    // Initial form validation
    validateForm();

    // WhatsApp numarası formatlama fonksiyonu (generate_story.html'den alınan mantık)
    function formatWhatsAppNumber(input) {
        let value = input.value.replace(/\D/g, ''); // Sadece rakamları al
        if (value.startsWith('0')) value = value.substring(1);
        if (value.startsWith('90')) value = value.substring(2);
        if (value.length > 0 && !value.startsWith('5')) {
            input.setCustomValidity('WhatsApp numarası 5 ile başlamalıdır');
            return;
        }
        if (value.length > 10) value = value.substring(0, 10);
        let formatted = '';
        if (value.length > 0) {
            formatted = '+90 ' + value.substring(0, 3);
            if (value.length > 3) formatted += ' ' + value.substring(3, 6);
            if (value.length > 6) formatted += ' ' + value.substring(6, 8);
            if (value.length > 8) formatted += ' ' + value.substring(8, 10);
        }
        input.value = formatted;
        input.setCustomValidity('');
    }
    // Input'a formatlama ekle
    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('input', function() {
        formatWhatsAppNumber(this);
        this.setCustomValidity('');
    });
    phoneInput.addEventListener('blur', function() {
        formatWhatsAppNumber(this);
    });
    phoneInput.addEventListener('keypress', function(e) {
        if (!/[\d\s+\-]/.test(e.key)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %} 